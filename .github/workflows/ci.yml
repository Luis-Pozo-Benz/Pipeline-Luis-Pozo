name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    - name: Tests unitarios
      run: cd Pipeline && mvn test

  docker:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    - name: Build JAR
      run: cd Pipeline && mvn package -DskipTests
    - name: Docker test
      run: |
        cd Pipeline
        docker compose up -d postgres
        timeout 60 sh -c 'until docker compose ps | grep "Up" | grep postgres; do sleep 1; done'
        docker compose up --build app &
        APP_PID=$!
        timeout 120 sh -c 'until curl -f http://localhost:8080/actuator/health 2>/dev/null || curl -f http://localhost:8080/personas 2>/dev/null; do sleep 2; echo "Esperando..."; done'
        curl -f http://localhost:8080/personas
        curl -f http://localhost:8080/zapatos
        echo "Pipeline EXITOSA"
        docker compose down || true
